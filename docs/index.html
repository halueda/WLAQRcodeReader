<!DOCTYPE html>
<!-- Time-stamp: <2024-07-18 13:13:26 ueda@SCR-00103236> -*- mode: real-auto-save; -*- -->

<html lang="ja">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>WLA QR Code Reader</title>
    <meta name="description" content="WLA QR Code Reader" />
    <script src="./jsQR.js"></script>
  </head>
  <body>
    <!-- 縦にアラインする -->
    <style>
      .form-group {
	  display: flex;
	  flex-direction: column;
	  align-items: flex-start;
      }
      html {
	  font-size: 18px; /* デフォルトのフォントサイズを18pxに設定 */
      }
    </style>

    <form id="myForm">
      <div class="form-group">
	<label for="fname">サービスマン氏名：</label>
	<input type="text" id="fname" name="fname">
      </div>
      <div class="form-group">
	<label for="result">QRcode：</label>
	<input type="text" id="result" value="" style="min-height: 20px;" readonly>
      </div>
      <input type="submit" value="登録"> 
    </form>
    <div>
      <!-- ここに Start/Stop のトグルボタンをつける -->
      <button onclick="toggleReader()">読み込み</button>
      <div style="position:relative;">
        <video style="position: absolute; z-index: -100;"></video>
        <div id="overlay" style="position: absolute; border: 1px solid #F00;"></div>
      </div>      
    </div>

    <script>
      <!-- JSONでWebAPIにput -->
      document.getElementById('myForm').addEventListener('submit', function(e) {
	e.preventDefault(); // デフォルトのフォーム送信を防ぐ

	// フォームデータを取得
	var formData = new FormData(this);

	// JSONオブジェクトに変換
	var object = {};
	formData.forEach(function(value, key){
	  object[key] = value;
	});
	// <!-- TODO: 送信日時など自動的に設定する値を追加 -->
	var json = JSON.stringify(object);

	// PUTリクエストを送信
	fetch('あなたのAPIエンドポイント', { // APIエンドポイントには実際のURLを使用してください <!-- TODO: 送信先はまだない -->
	  method: 'PUT', // リクエストメソッド
	  headers: {
	    'Content-Type': 'application/json' // コンテンツタイプ
	  },
	  body: json // 送信するJSONデータ
	}).then(response => {
	  if (response.ok) {
	    return response.json(); // レスポンスのJSONを取得
	  }
	  throw new Error('Network response was not ok.');
	}).then(data => {
	  console.log('Success:', data); // 成功時の処理
	  const readonlyInput = document.getElementById('result'); <!-- QR-code をクリア -->
	  readonlyInput.value = ''
	  // TODO: 受付番号もクリアする
	  // TODO: QR-readerを止める
	}).catch(error => {
	  console.error('Error:', error); // TODO: エラー時の処理 
	});
      });
    </script>

    <script>
      <!-- QR code reader -->
      const constraints = { 
        audio: false, 
        video: {
          facingMode: 'environment', 
          width: 500, 
          height: 500, 
      }};

      const drawRect = (topLeft, bottomRight) => {
        const { x: x1, y: y1 } = topLeft;
        const { x: x2, y: y2 }= bottomRight;

        const overlay = document.querySelector('#overlay');
        overlay.style.left = `${x1}px`;
        overlay.style.top =`${y1}px`;
        overlay.style.width = `${x2 - x1}px`;
        overlay.style.height =`${y2 - y1}px`;
      };

      const video = document.querySelector('video');
      video.playing = false; // 初期値は読み取り状態ではない

      // 読み取りボタンが押されたら以下を起動する
      const toggleReader = () => {
        const video = document.querySelector('video');
	video.playing = ! video.playing;
	if (video.playing) {
	  startReader();
	}
      };

      (async() => {
        try {
          const stream = await navigator.mediaDevices.getUserMedia(constraints);
          const video = document.querySelector('video');
          video.srcObject = stream;

	  // startReader();
        } catch(error) {
          console.log('load error', error);
        }
      })();

      const startReader = () => {
	(async() => {
          try {
            const video = document.querySelector('video');
	    video.style.display = "block";
            video.play();

            const { width, height } = constraints.video;
            const canvas = new OffscreenCanvas(width, height);
            const context = canvas.getContext('2d');
	    
            const timer = setInterval(() => {
	      if ( !video.playing ) {
                drawRect({x:0, y:0}, {x:0, y:0}); // rectangle を消す
		video.pause(); // ビデオの再生を停止
		video.currentTime = 0; // ビデオを最初に巻き戻す
		video.style.display = "none"; // 非表示
		clearInterval(timer);
		return;
	      };
              context.drawImage(video, 0, 0, width, height);
              const imageData = context.getImageData(0, 0, width, height);
              const code = jsQR(imageData.data, imageData.width, imageData.height);
              if (code) {
		const readonlyInput = document.getElementById('result');
		readonlyInput.value = code.data // TODO: MAC-addr だけ取り出す。 TODO: 可能ならWLAの世代を取り出す
		readonlyInput.readOnly = true; // 読み取り専用に設定
                //document.querySelector('#result').textContent = code.data;
                drawRect(code.location.topLeftCorner, code.location.bottomRightCorner);
              } else {
                // document.querySelector('#result').textContent = ''; <!-- 最後の読み取りを維持する -->
              }
            }, 300);
          } catch(error) {
            console.log('load error', error);
          }
	})();
      };
    </script>
  </body>
</html>

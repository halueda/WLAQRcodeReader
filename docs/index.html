<!DOCTYPE html>
<!-- Time-stamp: <2024-07-19 17:32:12 ueda@SCR-00103236> -*- mode: real-auto-save; -*- -->

<html lang="ja">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>WLA QR Code Reader</title>
    <meta name="description" content="WLA QR Code Reader" />
    <script src="./jsQR.js"></script>
  </head>
  <body>
    <style>
      /* 縦にアラインする */
      .form-group {
	  display: flex;
	  flex-direction: column;
	  align-items: flex-start;
      }
      /* デフォルトのフォントサイズを設定 */
      * {
	  font-size: 20px; 
      }

    </style>

<!--
UKETSUKE_NO: requestJSON.UKETSUKE_NO,
MAC: requestJSON.MAC,
SHAIN_MEI: requestJSON.SHAIN_MEI,
-->
    <form id="myForm">
      <div class="form-group">
	<label for="SHAIN_MEI">サービスマン氏名：</label>
	<input type="text" id="SHAIN_MEI" name="SHAIN_MEI">
      </div>
      <div class="form-group">
	<label for="UKETSUKE_NO">受付番号：</label>
	<input type="text" id="UKETSUKE_NO" name="UKETSUKE_NO">
      </div>
      <div class="form-group">
	<label for="MAC">QRcode：</label>
	<input type="text" id="MAC" value="" style="min-height: 20px;" readonly>
      </div>
      <input type="submit" value="登録"> 
    </form>
    <div>
      <!-- Start/Stop のトグルボタン -->
      <br/>
      <button onclick="toggleReader()">読み込み</button>
      <div style="position:relative;">
        <video style="position: absolute; z-index: -100;"></video>
        <div id="overlay" style="position: absolute; border: 1px solid #F00;"></div>
      </div>      
    </div id="debugoutput" style="font-size: 8px;" >
    <div>
    </div>

    <script>
      // 合言葉関連
      // 合言葉は、 document.__global.auth に入れることにする

      // 最初に一発 ローカルストレージから読み込んで入れておく。
      let auth = localStorage.getItem('auth');
      if (!auth) { auth = ""; }
      document.__global = { "auth": auth };

      function auth_prompt() {
	// 合言葉を聞く関数
	// 入力ダイアログを表示 ＋ 入力内容を user に代入
	let auth = window.prompt("合言葉を入力してください", document.__global.auth); // 初期値があるならそれも入れる
	if (!auth) { auth = ""; }
	localStorage.setItem('auth', auth);
	document.__global.auth = auth
	return auth;
      }
    </script>

    <script>
      // JSONでWebAPIにput 
      document.getElementById('myForm').addEventListener('submit', function(e) {
	e.preventDefault(); // デフォルトのフォーム送信を防ぐ

	// フォームデータを取得
	var formData = new FormData(this);

	// JSONオブジェクトに変換
	var object = {};
	formData.forEach(function(value, key){
	  object[key] = value;
	});
	// <!-- TODO: 送信日時など自動的に設定する値を追加 -->
	var json = JSON.stringify(object);

	// PUTリクエストを送信

	fetch_with_auth_prompt( 'https://i2uisu0dsg.execute-api.ap-northeast-1.amazonaws.com/items',
				'PUT', json );
//	fetch('https://i2uisu0dsg.execute-api.ap-northeast-1.amazonaws.com/items', { // APIエンドポイント
//	  method: 'PUT', // リクエストメソッド
//	  headers: {
//	    'Content-Type': 'application/json' // コンテンツタイプ
//	  },
//	  body: json // 送信するJSONデータ
//	}).then(response => {
//	  if (response.ok) {
//	    return response.json(); // レスポンスのJSONを取得
//	  } else {
//	    // ToDo: クレデンシャルがない/違うなら、ユーザに合言葉を聞く
//	    throw new Error('Network response was not ok.');
//	  }
//	}).then(data => {
//	  console.log('Success:', data); // 成功時の処理
//	  const readonlyInput = document.getElementById('MAC'); <!-- QR-code をクリア -->
//	  readonlyInput.value = ''
//	  // TODO: 受付番号もクリアする
//	  // TODO: QR-readerを止める
//	}).catch(error => {
//	  console.error('Error:', error); // TODO: エラー時の処理 
//	});
      });


      // 必要なら合言葉を聞いて、fetchを繰り返す
      async function fetch_with_auth_prompt( endpoint, method, body ) {
	let state = 'again'
	while ( state == 'again' ) {
	   await fetch(endpoint, // APIエンドポイント
		       { method: method, // リクエストメソッド
			 headers: {
			   'Content-Type': 'application/json',	 // コンテンツタイプ
			   'Authorization': "Basic " + btoa( document.__global.auth ) // Basic 認証
			 },
			 body: body // 送信するJSONデータ
		       })
	    .then(response => {
	      if (response.ok) {
		return response.json(); // レスポンスのJSONを取得

	      } else if ( response.status == 401 || response.status == 403 ) { // 認証失敗（そもそも情報がなかった）、認証不許可(パスワードが変わった）
		auth_prompt();  // パスワードを聞く
		state='again' ; // もう一度ループ
	      } else {
		state='fail';
		throw new Error('Network response was not ok.');
	      }
	    })
	    .then( data => { // レスポンスのJSON
	      console.log('Success:', data); // 成功時の処理 ⇒ どこか下の方に結果を見せる。デバッグも兼ねて
	      // うまくいったので後始末
	      const debugoutput = document.getElementById('debugoutput');
	      debugoutput.value = JSON.stringify(data) + "\n" + debugoutput.value;
	      // QR-code をクリア
	      const readonlyInput = document.getElementById('MAC');
	      readonlyInput.value = '';
	      // TODO: 受付番号もクリアする
	      // TODO: QR-readerを止める
	      state = 'done';
	    })
	    .catch(
	      //     回復不能なのであきらめる
	      state = 'fail'
	      console.error()
	    );
	}
      }
    </script>

    <script>
      <!-- QR code reader -->
      const constraints = { 
        audio: false, 
        video: {
          facingMode: 'environment', 
          width: 500, 
          height: 500, 
      }};

      const drawRect = (topLeft, bottomRight) => {
        const { x: x1, y: y1 } = topLeft;
        const { x: x2, y: y2 }= bottomRight;

        const overlay = document.querySelector('#overlay');
        overlay.style.left = `${x1}px`;
        overlay.style.top =`${y1}px`;
        overlay.style.width = `${x2 - x1}px`;
        overlay.style.height =`${y2 - y1}px`;
      };

      const video = document.querySelector('video');
      video.playing = false; // 初期値は読み取り状態ではない

      // 読み取りボタンが押されたら以下を起動する
      const toggleReader = () => {
        const video = document.querySelector('video');
	video.playing = ! video.playing;
	if (video.playing) {
	  startReader();
	}
      };

      const startReader = () => {
	(async() => {
          try {
            const stream = await navigator.mediaDevices.getUserMedia(constraints);
            const video = document.querySelector('video');
            video.srcObject = stream;

	    video.style.display = "block";
            video.play();

            const { width, height } = constraints.video;
            const canvas = new OffscreenCanvas(width, height);
            const context = canvas.getContext('2d');
	    
            const timer = setInterval(() => {
	      if ( !video.playing ) {
                drawRect({x:0, y:0}, {x:0, y:0}); // rectangle を消す
		video.pause(); // ビデオの再生を停止
		video.currentTime = 0; // ビデオを最初に巻き戻す
		stream.getTracks().forEach(track => track.stop()); //カメラの利用を停止
		video.style.display = "none"; // 非表示
		clearInterval(timer);
		return;
	      };
              context.drawImage(video, 0, 0, width, height);
              const imageData = context.getImageData(0, 0, width, height);
              const code = jsQR(imageData.data, imageData.width, imageData.height);
              if (code) {
		const readonlyInput = document.getElementById('MAC');
		readonlyInput.value = code.data // TODO: MAC-addr だけ取り出す。 TODO: 可能ならWLAの世代を取り出す
		readonlyInput.readOnly = true; // 読み取り専用に設定
                //document.querySelector('#MAC').textContent = code.data;
                drawRect(code.location.topLeftCorner, code.location.bottomRightCorner);
              } else {
                // document.querySelector('#MAC').textContent = ''; <!-- 最後の読み取りを維持する -->
              }
            }, 300);
          } catch(error) {
            console.log('load error', error);
          }
	})();
      };
    </script>
  </body>
</html>

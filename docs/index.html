<!DOCTYPE html>
<!-- Time-stamp: <2024-08-06 13:41:27 ueda@SCR-00103236> -*- mode: real-auto-save; -*- -->

<html lang="ja">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>WiFi QR Code Reader</title>
    <meta name="description" content="WLA QR Code Reader" />
    <!-- FABICON設定（Androidのみ） -->
    <!--link rel="icon" href="/favicon.ico" sizes="32x32"--><!-- 32×32 -->
    <link rel="icon" href="./favicon.ico" >
    <!-- link rel="icon" href="/icon.svg" type="image/svg+xml" -->
    <!-- link rel="apple-touch-icon" href="/apple-touch-icon.png"--><!-- 180×180 -->
    <link rel="manifest" href="./manifest.webmanifest">
    <!-- フルスクリーンモード -->
    <!-- iOS用 -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <!-- Android用 -->
    <meta name="mobile-web-app-capable" content="yes">
    <script src="./jsQR.js"></script>
  </head>
  <body>
    <style>
      /* 縦にアラインする */
      .form-group {
          display: flex;
          flex-direction: column;
          align-items: flex-start;
      }
      /* デフォルトのフォントサイズを設定 */
      * {
          font-size: 20px; 
      }
      /* カメラを拡大する ⇒ 表示は大きくなるが、視野は変わらないし、どうしてもずれるので使わないことにした*/
      /* .no-camera {
	      transform: scale(1.0);
	      transform-origin: 0% 0% 0px;
      } */

    </style>

    <h1>WiFi QR Code Reader</h1>
    <form id="myForm">
      <!-- div class="form-group" -->
        <label for="SHAIN_MEI">ユーザID：</label><br/>
        <input type="text" id="HOKOKU_TANTOSHA_CD" name="HOKOKU_TANTOSHA_CD" placeholder="担当者コード" size="8" inputmode="tel"> - <input type="text" id="HOKOKU_KAKUCHO_CD" name="HOKOKU_KAKUCHO_CD" placeholder="拡張コード" size="5" inputmode="tel">
      <!-- /div --><br/>
      <div class="form-group">
        <label for="UKETSUKE_NO">受付番号：</label>
        <input type="text" id="UKETSUKE_NO" name="UKETSUKE_NO" inputmode="tel" placeholder="受付番号" >
      </div>
      <div class="form-group">
        <label for="QR">QRcode：</label>
        <input type="text" id="QR" name="QR" value="" onclick="toggleReader()" placeholder="タッチで読み込み" size="27" readonly >
      </div>
      <input type="submit" value="登録"> 
      <br/>
    </form>
    <div >
      <div class="camera" style="position:relative;">
        <video style="position: absolute; z-index: -100;"></video>
        <div id="overlay" style="position: absolute; border: 1px solid #F00;"></div>
      </div>      
    </div>
    <p id="debugoutput" style="font-size: 8px;" >
    </p>

    <script>
      // 合言葉関連
      // 合言葉は、 document.__global.auth に入れることにする

      // 最初に一発 ローカルストレージから読み込んで入れておく。
      let auth = localStorage.getItem('WiFiQRcodeReader_auth') ?? '';
      document.__global = { "auth": auth };

      function auth_prompt() {
        // 合言葉を聞く関数
        // 入力ダイアログを表示 ＋ 入力内容を user に代入
        let auth = window.prompt("合言葉を入力してください", document.__global.auth) ?? '' ; // 初期値があるならそれも入れる
        if (! auth ) { //cancel
          return null;
        }
        localStorage.setItem('WiFiQRcodeReader_auth', auth);
        document.__global.auth = auth
        return auth;
      }
    </script>

    <script>
      // JSONでWebAPIにput 
      document.getElementById('myForm').addEventListener('submit', function(e) {
        e.preventDefault(); // デフォルトのフォーム送信を防ぐ
        // フォームデータを取得
        var formData = new FormData(this);
        // Readerは止める
        stopReader();
        // JSONオブジェクトに変換
        var object = {};
        formData.forEach(function(value, key){
          object[key] = value;
        });

	// データが足りてなければエラー
        var mes = "";

        if ( ! object["HOKOKU_TANTOSHA_CD"] ) {
          mes = mes + "担当者コードを入力してください\n";
        }

        if ( ! object["HOKOKU_KAKUCHO_CD"] ) {
          mes = mes + "拡張コードを入力してください\n";
        }
        
        if ( ! object["UKETSUKE_NO"] ) {
          mes = mes + "受付番号を入力してください\n";
        }

        if ( ! object["QR"] ) {
          mes = mes + "QRコードが読めていません\n";
        }

        if (mes) {
          alert(mes);
          return;
        }

        // QR
        //  **アダプタラベル (QR1)**:  
        //  AP-WH3E-00E93A47445B;8XvfnMXk;1
        //
        //  **WiFi2 ラベル (QR2)**:  
        //  AP-WH3E-00E93A47445B;8XvfnMXk;2
        object.MAC        = object.QR.substr(8, 12);
        object.WLAVersion = object.QR.substr(30, 1);

        // Now  2023-09-13T07:18:45.324Z
        let nowDate = new Date();
        nowDate.setHours(nowDate.getHours() + 9); // convert to JST
        const dateStr = nowDate.toISOString();
        object.KANRYO_DT = dateStr.substr(0,10);
        object.KANRYO_TM = dateStr.substr(11,8);

        // GPS ... 時間がかかるようなので一旦あきらめる。このページを開いている間は、ずっと監視していて、大域変数に最後の値をコピーし、使う方はノーチェックで使うことにする
        /*
        const getCoords = async () => {
          const pos = await new Promise((resolve, reject) => {
            navigator.geolocation.getCurrentPosition(resolve, reject);
          });
    
          return {
            Longitude: pos.coords.longitude,
            Latitude: pos.coords.latitude,
          };
        };

        const coords = await getCoords();

        object.Longitude = coords.Longitude;
        object.Latitude = coords.Latitude;
        */

        // 出力
        var json = JSON.stringify(object);

        // PUTリクエストを送信
        fetch_with_auth_prompt( 'https://s5ijs5y2w5.execute-api.ap-northeast-1.amazonaws.com/items',
                                'PUT', json );
      });


      // 必要なら合言葉を聞いて、fetchを繰り返す
      async function fetch_with_auth_prompt( endpoint, method, body ) {
        let state = 'again'
        while ( state == 'again' ) {
          const response = await fetch(endpoint, { // APIエンドポイント
            method: method, // リクエストメソッド
            //mode: 'no-cors', // 追加: CORS モードを 'no-cors' に設定
            headers: {
              'Content-Type': 'application/json',   // コンテンツタイプ
              'Authorization': "Basic " + btoa( document.__global.auth ) // Basic 認証
            },
            body: body // 送信するJSONデータ
          });

          if (response.ok) {
            // 結果を見せる
            //const debugoutput = document.getElementById('debugoutput');
            //debugoutput.innerText = JSON.stringify(data) + "\n" + (debugoutput?.innerText ?? '');
            const data = await response.json(); // レスポンスのJSONを取得
            alert('登録成功: ' + JSON.stringify(data)); // 取得したJSONをアラートで表示
            // うまくいったので後始末
            // QR-code をクリア
            const qrcode = document.getElementById('QR');
            qrcode.value = '';
            // 受付番号もクリアする
            const uketsuke_NO = document.getElementById('UKETSUKE_NO');
            uketsuke_NO.value = '';
            
            state = 'done';
            break;
          } else if ( response.status == 401 || response.status == 403 ) { // 認証失敗（そもそも情報がなかった）、認証不許可(パスワードが変わった）
            let auth = auth_prompt();  // パスワードを聞く
            if (auth === null) {
              console.error('AuthCancell', '');
              alert('正しいパスワードを入れてください ');
              state='cancel';
              break;
            } else {
              state='again' ; // もう一度ループ
              continue;
            }
          } else {
            state='fail';
            //throw new Error('Network response was not ok.');

            console.error('Error:', error);
            alert('Error: ' + error);
            break;
          }
        }
      }
    </script>

    <script>
      <!-- QR code reader -->
      const constraints = { 
        audio: false, 
        video: {
          facingMode: 'environment', 
          width: 1500, 
          height: 1500, 
      }};

      const drawRect = (topLeft, bottomRight) => {
        const { x: x1, y: y1 } = topLeft;
        const { x: x2, y: y2 }= bottomRight;

        const overlay = document.querySelector('#overlay');
        overlay.style.left = `${x1}px`;
        overlay.style.top =`${y1}px`;
        overlay.style.width = `${x2 - x1}px`;
        overlay.style.height =`${y2 - y1}px`;
      };

      const video = document.querySelector('video');
      video.playing = false; // 初期値は読み取り状態ではない

      // 読み取りボタンが押されたら以下を起動する
      function toggleReader () {
        const video = document.querySelector('video');
        video.playing = ! video.playing;
        if (video.playing) {
          startReader();
        }
      }

      // gracefulに止める
      function stopReader () {
        const video = document.querySelector('video');
        video.playing = false;
      }

      function startReader () {
        (async() => {
          try {
            const stream = await navigator.mediaDevices.getUserMedia(constraints);
            const video = document.querySelector('video');
            video.srcObject = stream;

            video.style.display = "block";
            video.play();

            const { width, height } = constraints.video;
            const canvas = new OffscreenCanvas(width, height);
            //const context = canvas.getContext('2d');
            const context = canvas.getContext('2d', { willReadFrequently: true });
            
            const timer = setInterval(() => {
              if ( !video.playing ) {
                drawRect({x:0, y:0}, {x:0, y:0}); // rectangle を消す
                video.pause(); // ビデオの再生を停止
                video.currentTime = 0; // ビデオを最初に巻き戻す
                stream.getTracks().forEach(track => track.stop()); //カメラの利用を停止
                video.style.display = "none"; // 非表示
                clearInterval(timer);
                return;
              };
              context.drawImage(video, 0, 0, width, height);
              const imageData = context.getImageData(0, 0, width, height);
              const code = jsQR(imageData.data, imageData.width, imageData.height, {
                     inversionAttempts: "dontInvert",
                  });      
              if (code) {
                const qrcode = document.getElementById('QR');
                qrcode.value = code.data
                qrcode.readOnly = true; // 読み取り専用に設定
                drawRect(code.location.topLeftCorner, code.location.bottomRightCorner);
              } else {
                // document.querySelector('#MAC').textContent = ''; <!-- 最後の読み取りを維持する -->
              }
            }, 30);
          } catch(error) {
            console.log('load error', error);
          }
        })();
      };
    </script>
  </body>
</html>
